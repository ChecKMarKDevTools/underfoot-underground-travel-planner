pre-commit:
  parallel: true
  commands:
    format-and-lint:
      run: |
        STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
        if [ -n "$STAGED_FILES" ]; then
          echo "$STAGED_FILES" | xargs -r npm run format
          echo "$STAGED_FILES" | xargs -r npm run lint
          echo "$STAGED_FILES" | xargs -r git add
        fi
    spellcheck:
      run: |
        STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
        if [ -n "$STAGED_FILES" ]; then
          npx cspell --show-suggestions $STAGED_FILES
        fi

pre-push:
  parallel: true
  commands:
    tests:
      run: npm test

commit-msg:
  parallel: true
  commands:
    commitlint:
      run: |
        OUTPUT=$(npm run commitlint -- {1} 2>&1)
        echo "$OUTPUT"
        # If commitlint exited with non-zero (errors), fail immediately
        STATUS=$?
        if [ $STATUS -ne 0 ]; then
          exit $STATUS
        fi
        # Treat any 'warning' lines as failure to enforce stricter policy without level=2 in config
        if echo "$OUTPUT" | grep -qi "warning"; then
          echo "Commit message contains warnings (treated as errors by lefthook)." >&2
          exit 1
        fi
