*Document created: September 27, 2025*

## Cloudflare Pages Deployment (Frontend)

This project can be deployed to Cloudflare Pages with minimal setup. The backend (Node/Express) is separate; this guide focuses on the `frontend` Vite React app.

### 1. Build Output

The Vite build outputs static assets to `frontend/dist/`. Cloudflare Pages just needs that directory.

### 2. Environment Variables

Set any (optional) chat integration variables in the Pages project dashboard or via `wrangler`:

- `VITE_N8N_CHAT_IFRAME_URL` — Full URL to a hosted n8n Chat UI. If set, the `/n8n-chat` route renders an `<iframe>` (fastest path).
- `VITE_N8N_CHAT_WEBHOOK_URL` — Public webhook endpoint produced by an n8n Chat Trigger. If provided (and no iframe URL) the embedded widget mode will load `@n8n/chat` dynamically.
- `VITE_N8N_CHAT_METADATA` — (Optional) JSON string with metadata forwarded to n8n in widget mode. Example: `{"appVersion":"0.1.0"}`.

You can force the iframe mode during testing with the query param: `/n8n-chat?iframe=1` (will fallback to `about:blank` if the env var is absent — useful for CI / smoke tests).

### 3. Project Settings (Pages)

1. Create a new Pages project, connect this GitHub repo.
2. Set:
   - Framework preset: None (or React — both fine)
   - Build command: `npm --prefix frontend install && npm --prefix frontend run build`
   - Build output directory: `frontend/dist`
3. Add environment variables as needed (see above).
4. Save and trigger first deploy.

### 4. Local Preview with Wrangler (Optional)

```
npm install
cd frontend
npm run build
npx wrangler pages dev dist
```

Then open the printed preview URL and visit `/n8n-chat`.

### 5. GitHub Actions (CI → Pages)

We include a workflow (`.github/workflows/cloudflare-pages.yml`) that builds only the frontend and publishes using `cloudflare/pages-action`. You must add the following GitHub repository secrets:

- `CLOUDFLARE_API_TOKEN` — Pages deploy token (Pages: Edit + Deploy permissions).
- `CLOUDFLARE_ACCOUNT_ID` — Your account ID.

Optional, if you want a named project override (otherwise project inferred):

- `CLOUDFLARE_PAGES_PROJECT`

### 6. Caching & Invalidation

Pages handles immutable asset hashing (Vite fingerprints). If you adjust caching rules, ensure `index.html` remains non‑cached or short‑lived so new builds propagate quickly.

### 7. Backend / API Options

You now have three deployment modes for the API layer:

| Mode | When to Use | Notes |
| - | - | - |
| External Node Host | You already deployed Express elsewhere | Set `VITE_API_BASE` to that host |
| Cloudflare Worker (this repo) | Want edge latency + simple state | Use `cloudflare-worker/` directory |
| Pages Functions | Single project (static + functions) | Port core routes into `/functions` |

#### 7.1 Deploy the Worker (API)

Directory: `cloudflare-worker/`

1. Install deps at root (wrangler is a devDependency now): `npm install`
2. Authenticate: `npx wrangler login`
3. Set required secret: `npx wrangler secret put STONEWALKER_WEBHOOK`
4. (Optional) Secrets: `GEOAPIFY_API_KEY`, `OPENAI_API_KEY`
5. Deploy: `npm run deploy:worker`
6. Note the deployed URL, e.g. `https://underfoot-backend.your-account.workers.dev`
7. In Cloudflare Pages project settings add env `VITE_API_BASE` pointing to that URL.

Endpoints provided:

| Route | Method | Purpose |
| - | - | - |
| `/health` | GET | Basic status & cache size |
| `/underfoot/chat` | POST | Pass-through chat to upstream n8n (body `{ chatInput }`) |
| `/underfoot/chat?chatInput=...&stream=true` | GET | SSE (start / complete / heartbeat / end) |

Edge cache is in-memory per isolate. For multi-region coherence migrate to KV or Durable Object.

#### 7.2 Pages Functions (Future)

If you prefer a single Pages project, replicate the Worker logic inside `frontend/functions/underfoot/chat.js` and `frontend/functions/health.js`.

### 8. Troubleshooting

### 9. Troubleshooting

| Symptom | Likely Cause | Fix |
| - | - | - |
| `/n8n-chat` shows "Chat Not Configured" | Missing both chat env vars | Set one of the vars in Pages dashboard and redeploy |
| E2E test fails to find iframe | Build didn’t have `VITE_N8N_CHAT_IFRAME_URL` & query param unused | Use `/n8n-chat?iframe=1` or set env var |
| Widget not loading | `@n8n/chat` dynamic import blocked or wrong webhook URL | Verify webhook URL is publicly reachable (200) |

### 10. Minimal Principle Recap

KISS & DRY: a single `N8nChatPage` chooses iframe vs. widget at runtime; no routing library added, no duplicate markup, dynamic import only when needed.

---

Generated by automation to document Cloudflare deployment for the n8n chat page.

---

*This document was generated with Verdent AI assistance.*
